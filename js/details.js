$(function(){var module={url:{getTicktes:"award.ca?type=getradata",getPrize:"award.ca?type=getadata",changeAwardState:"award.ca?type=awrad"},awardrank:null,hadAlert:!1,awardPull:[],ticketId:null,SECOND:5,imgUrls:["camera","iphone","ipad","2000","1000","800","500","300"],init:function(){var e=this;this.initEnterActive(),g.checkLogin(function(){e.awardrank=g.getUserInfo().awardrank,e.render()},function(){alert("请先登录"),document.location.href="login.html"})},initEnterActive:function(){$("#about_tigger").bind("click",function(){$("#page_about").fadeOut()}),$("#prelude_introduce , #scratch_introduce").bind("click",function(){$("#page_about").fadeIn()})},render:function(){var e=this;if(e.awardrank>=0){$("#page_prelude").hide(),$("#page_scratch").show();var t=g.getUserInfo();$("#scratch_user").html(t.username+" "+t.mobile);var n=new Image;n.addEventListener("load",function(t){e.doRenderStatus(n)}),n.src="../images/lottery/"+e.imgUrls[e.awardrank]+".jpg"}else e.doRenderShuffle(function(t){var t=parseInt(t/e.awardPull.length,10);e.ticketId=this.awardPull[t],$("#prelude_downcount").hide(),$("#page_prelude").hide(),e.getMyAward()})},doRenderStatus:function(e){var t=$("#gua_border"),n=t.find("canvas");n.hide(),t.find(".bg")[0].style.backgroundImage="url("+e.src+")",$("#scratch_result").show()},doRenderTickets:function(e){var t=this,n=$("#prelude_main");g.loadingMask.open(),$.ajax({url:g.url.host+t.url.getTicktes+"&mobile="+g.getUserInfo().mobile,cache:!1,success:function(n){n=JSON.parse(n);var r=n.data;r.length<=0&&alert("你来晚了，没有票了"),t.awardPull=r,t.awardPull.sort(function(){return.5-Math.random()}),$("#prelude_begin").show(),g.loadingMask.close(),t.initDownCount(),e&&e.call()},error:function(e){e.statusText=="timeout"?(alert("服务器请求超时无响应，请刷新页面"),document.location.reload()):alert("出票失败，请刷新页面"),g.loadingMask.close()}})},initDownCount:function(){var e=this,t=$("#prelude_downcount"),n=t.find("em").eq(0),r=t.find("em").eq(1),i=e.SECOND;$("#prelude_downcount").show(),n.text(i);var s=setInterval(function(){i>=0?(r.text(i),i--):(clearInterval(s),e.ticketId==null&&(alert("超过时限，系统将重新选择奖券"),document.location.reload())),e.ticketId!==null&&clearInterval(s)},1e3)},doRenderShuffle:function(e){function n(){t.doRenderTickets(function(){var n=$("#prelude_main").children(),r=[1,2,3,4,5,6,7,8,9];r.sort(function(){return.5-Math.random()});for(var i=0,s=r.length;i<s;i++)n[i].src="../images/pre_gua/back/"+r[i]+".png";n.addClass("item_mi"),$("#prelude_begin").hide(),$("#prelude_tip").show(),n.bind("click",function(){console.log("click");var n=$(this).index();e.call(t,n)}),n.bind("webkitTransitionEnd",function(){n.removeClass("item_mi")})})}var t=this;$("#prelude_begin").bind("click",function(){n()})},getMyAward:function(e){var t=this;g.loadingMask.open(),$.ajax({url:g.url.host+t.url.getPrize+"&"+g.getUserInfo().mobile+"&id="+t.ticketId,cache:!1,success:function(e){e=JSON.parse(e);if(e.result){t.awardrank=e.data.awardrank,$("#page_scratch").show();var n=g.getUserInfo();$("#scratch_user").html(n.username+" "+n.mobile);var r=new Image;r.addEventListener("load",function(e){t.doRenderTicket(r)}),r.src="../images/lottery/"+t.imgUrls[t.awardrank]+".jpg"}else alert("奖品兑换失败，请刷新页面重试");g.loadingMask.close()},error:function(e){e.statusText=="timeout"?(alert("服务器请求超时无响应，请刷新页面"),document.location.reload()):alert("奖品兑换失败，请刷新页面重试"),g.loadingMask.close()}})},doRenderTicket:function(img){function eventDown(e){e.preventDefault(),mousedown=!0;var t=$(this).offset();offsetX=t.left,offsetY=t.top}function eventUp(e){e.preventDefault(),mousedown=!1;var t=getTransparentPercent();t>50&&($(this).fadeOut("fast"),_this.submitState())}function eventMove(e){e.preventDefault();if(mousedown){e.changedTouches&&(e=e.changedTouches[e.changedTouches.length-1]);var x=(e.clientX+document.body.scrollLeft||e.pageX)-offsetX||0,y=(e.clientY+document.body.scrollTop||e.pageY)-offsetY||0;with(ctx)beginPath(),arc(x,y,40,0,Math.PI*2),fill()}}function getTransparentPercent(){var e=ctx.getImageData(0,0,w,h),t=e.data,n=[];for(var r=0,i=t.length;r<i;r+=4){var s=t[r+3];s<128&&n.push(r)}return(n.length/(t.length/4)*100).toFixed(2)}var _this=this,mousedown=!1,ctx,con=$("#gua_border"),w=con.width(),h=con.height(),canvas=con.find("canvas")[0];offsetX=null,offsetY=null,con.find(".bg")[0].style.backgroundImage="url("+img.src+")",canvas.width=w,canvas.height=h,ctx=canvas.getContext("2d"),ctx.fillStyle="gray",ctx.fillRect(0,0,w,h),ctx.globalCompositeOperation="destination-out",canvas.addEventListener("touchstart",eventDown),canvas.addEventListener("touchend",eventUp),canvas.addEventListener("touchmove",eventMove),canvas.addEventListener("mousedown",eventDown),canvas.addEventListener("mouseup",eventUp),canvas.addEventListener("mousemove",eventMove)},submitState:function(){var e=this;g.loadingMask.open(),$.ajax({url:g.url.host+e.url.changeAwardState+"&mobile="+g.getUserInfo().mobile+"&id="+e.ticketId,cache:!1,success:function(e){e=JSON.parse(e),e.result===!0?($("#scratch_result").fadeIn(),alert("您的刮奖结果已保存")):e.result===!1&&(e.errorcode==1?alert("该奖券已经被抽取过，请重新抽奖"):e.errorcode==2?alert("您已刮过奖，不需再次操作"):alert("刮奖结果没有保存成功，请刷新页面"),document.location.reload()),g.loadingMask.close()},error:function(e){e.statusText=="timeout"?(alert("服务器请求超时无响应，请刷新页面"),document.location.reload()):alert("刮奖结果没有保存成功，请刷新页面"),g.loadingMask.close()}})}};module.init(),g.fitPage()});